CREATE TABLE public.tenants (
    year_founded integer,
    subdomain character varying(100) unique NOT NULL,
    tenant_name character varying(255) NOT NULL,
    tenant_id uuid DEFAULT gen_random_uuid() NOT NULL,
    phone_number character varying(20),
    logo_url text,
    website text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    PRIMARY KEY (tenant_id)
);


CREATE TYPE public.user_role AS ENUM (
    'Superadmin',
    'Zonaladmin',
    'Admin',
    'Student',
    'Parent',
    'Employee',
    'Teacher'
);

CREATE TABLE public.users (
    user_id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name character varying(100) NOT NULL,
    username character varying(100) unique NOT NULL,
    middle_name character varying(100),
    last_name character varying(100) NOT NULL,
    phone_number character varying(20),
    password_hash character varying(255) NOT NULL,
    date_of_birth date,
    role user_role NOT NULL,
    tenant_id uuid references tenants(tenant_id),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);








CREATE TABLE public.campuses (    campus_id uuid DEFAULT gen_random_uuid() NOT NULL,
    tenant_id uuid references tenants(tenant_id),
    campus_name character varying(255) NOT NULL,
    address text NOT NULL,
    phone_number character varying(20),
    email character varying(255),
    is_main_campus boolean DEFAULT false,
    year_established integer,
    no_of_floors integer DEFAULT 1 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    PRIMARY KEY (campus_id)
);

CREATE TYPE user_status AS ENUM (
    'active', 
    'inactive', 
    'alumni'
);
CREATE TABLE public.user_statuses (
    username character varying(100) references  users(username)NOT NULL,
    campus_id uuid  references campuses(campus_id) NOT NULL,
    tenant_id uuid references tenants(tenant_id) NOT NULL,
    status user_status NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    PRIMARY KEY (username, campus_id)
);


CREATE TABLE public.curricula (
    curriculum_name character varying(100) NOT NULL,
    curriculum_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    campus_id uuid references campuses(campus_id) NOT NULL,
    curriculum_code character varying(20) NOT NULL
);


CREATE TABLE public.classes (
    class_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    campus_id  uuid references campuses(campus_id) NOT NULL,
    class_level integer,
    class_name character varying(50) Unique NOT NULL,
    -- This ensures a class name is unique within a specific campus
    CONSTRAINT unique_campus_class UNIQUE (campus_id, class_name)
);



CREATE TABLE public.academic_years (
	academic_year_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    year_name character varying(20) NOT NULL,
    year_type character varying(20) NOT NULL,
    start_date date,
    end_date date,
    start_time_of_day character varying(20),
    end_time_of_day character varying(20),
    shift_type character varying(20),
    curriculum_id integer references curricula(curriculum_id) NOT NULL,
    fromclass character varying(20) references classes(class_name) NOT NULL,
    toclass character varying(20) references classes(class_name) NOT NULL,
    medium character varying(20) NOT NULL,
    campus_id  uuid references campuses(campus_id) NOT NULL);

CREATE TABLE public.buildings (
    campus_id uuid references campuses(campus_id) NOT NULL,
    building_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    building_name character varying(100) NOT NULL,
    number_of_floors integer DEFAULT 1 NOT NULL
);

CREATE TYPE room_type_enum AS ENUM (
    'Classroom','Laboratory','Library','Staff Room','Auditorium','Office','Other');

CREATE TYPE room_status_enum AS ENUM ('available', 'booked');

CREATE TABLE public.campus_rooms (
    room_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    building_id integer references buildings(building_id)  NOT NULL,
    campus_id uuid references campuses(campus_id)  NOT NULL,
    room_number character varying(20) NOT NULL,
    floor_number integer DEFAULT 0 NOT NULL,
    room_type room_type_enum NOT NULL,
    capacity integer,
   Status room_status_enum DEFAULT 'available', 
   available_capacity integer
);



CREATE TABLE public.class_sections (
    section_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    academic_year_id integer references academic_years(academic_year_id) NOT NULL,
    class_id integer references classes(class_id)  NOT NULL,
    campus_id uuid references campuses(campus_id)  NOT NULL,
    section_name character varying(20) NOT NULL,
    room_id integer references academic_years(academic_year_id),
    primary_teacher_user_id bigint references users(user_id),
    student_monitor_user_id bigint references users(user_id),
    capacity integer
);






create TYPE public.subject_category AS ENUM (
    'Academic',
    'Sport',
    'Co-curricular',
    'Other'
);

CREATE TABLE public.subjects (
category subject_category DEFAULT 'Academic'::subject_category NOT NULL,
subject_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
campus_id  uuid references campuses(campus_id)  NOT NULL,
curriculum_id integer references curricula(curriculum_id) NOT NULL,
subject_name character varying(100) NOT NULL,
subject_code character varying(20)
);


create table public.section_subjects(
    section_subject_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    section_id integer references class_sections(section_id) NOT NULL,
    subject_id integer references subjects(subject_id)  NOT NULL,
    teacher_user_id bigint references users(user_id),
     CONSTRAINT section_subject  UNIQUE (section_id, subject_id)
);


"
public	syllabus_progress	"CREATE TABLE public.syllabus_progress (
    notes text,
    completed_at timestamp with time zone,
    started_at timestamp with time zone,
    status syllabus_status DEFAULT 'Pending'::syllabus_status NOT NULL,
    unit_id integer NOT NULL,
    section_subject_id integer NOT NULL,
    progress_id integer DEFAULT nextval('syllabus_progress_progress_id_seq'::regclass) NOT NULL,
    PRIMARY KEY (progress_id)
);
"
public	syllabus_units	"CREATE TABLE public.syllabus_units (
    unit_description text,
    unit_title character varying(255) NOT NULL,
    subject_id integer NOT NULL,
    unit_id integer DEFAULT nextval('syllabus_units_unit_id_seq'::regclass) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    sequence_order integer DEFAULT 0 NOT NULL,
    PRIMARY KEY (unit_id)
);

CREATE TYPE admission_type_enum AS ENUM (
    'New', 
    'Transfer', 
    'Re-admission'
);

CREATE TABLE student_enrollment (
    admission_number VARCHAR(50) PRIMARY KEY,
    admission_date DATE NOT NULL,
campus_id uuid NOT NULL REFERENCES campuses(campus_id),
username VARCHAR(100)  NOT NULL REFERENCES users(username);
    
    -- Assumes a table 'academic_years' with 'academic_year_id' as its primary key
    academic_year_id INT REFERENCES academic_years(academic_year_id),
    
    registration_number VARCHAR(50) UNIQUE,
    admission_type admission_type_enum NOT NULL,
    tc_number VARCHAR(50),
class_name character varying(50) REFERENCES classes(class_name),
section_id integer REFERENCES class_sections(section_id),
roll_number VARCHAR(20),
previous_school VARCHAR(255),
transport_details VARCHAR(255),
hostel_details VARCHAR(100),
scholarship_applied BOOLEAN NOT NULL DEFAULT FALSE,
constraint unique_section_student UNIQUE (campus_id, academic_year_id, Class_name, section_id, roll_number)

);

CREATE TYPE category_enum AS ENUM (
    'OC', 
    'OBC', 
    'SC', 
    'General', 
    'ST', 
    'BC', 
    'EWS'
);

CREATE TYPE gender_enum AS ENUM (
    'Male', 
    'Female', 
    'Other', 
    'Prefer_not_to_say'
);

CREATE TYPE blood_group_enum AS ENUM (
    'A+', 'A-', 
    'B+', 'B-', 
    'AB+', 'AB-', 
    'O+', 'O-', 
    'Unknown'
);

CREATE TABLE user_personal_details (
username VARCHAR(50) PRIMARY KEY REFERENCES users(username) ON DELETE CASCADE,
gender gender_enum,
    nationality VARCHAR(100),
    religion VARCHAR(50),
    caste VARCHAR(50),
    category category_enum,
    blood_group blood_group_enum,
    height_cm INT,
    weight_kg NUMERIC(5, 2),medical_conditions TEXT,
    allergies TEXT,
occupation VARCHAR(100),
income NUMERIC(12, 2));

CREATE TYPE public.relationship_enum AS ENUM (
    'Mother',
    'Father',
    'Guardian',
    'Other'
);

CREATE TABLE student_parent_relations (
   tenant_id uuid NOT NULL  REFERENCES tenants(tenant_id)
        ON DELETE CASCADE,
campus_id uuid NOT NULL REFERENCES campuses(campus_id)
        ON DELETE CASCADE,
 student_username character varying(100) NOT NULL  REFERENCES users(username)
        ON DELETE CASCADE,
parent_username character varying(100) NOT NULL  REFERENCES users(username)
        ON DELETE CASCADE,
relationship_type public.relationship_enum,
is_emergency_contact BOOLEAN NOT NULL DEFAULT FALSE,
PRIMARY KEY ( campus_id, student_username, parent_username)
);

-- Optional: Indexes for faster lookups
CREATE INDEX idx_srp_student_username ON public.student_parent_relations(student_username);
CREATE INDEX idx_srp_parent_username ON public.student_parent_relations(parent_username);


CREATE TABLE user_contact_details (
    -- This is both the Primary Key and a Foreign Key
    username VARCHAR(50) PRIMARY KEY REFERENCES users(username) ON DELETE CASCADE,
	email VARCHAR(255) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    alt_phone VARCHAR(20),
	current_address TEXT,
    city VARCHAR(100),
    state VARCHAR(100),
    pincode VARCHAR(10),
    country VARCHAR(100),
	permanent_address TEXT,
emergency_contact_name VARCHAR(255),
 emergency_contact_phone VARCHAR(20), 
emergency_contact_relation relationship_enum );

CREATE TYPE employment_status_enum AS ENUM ('Active', 'On-Leave', 'Resigned', 'Terminated');
CREATE TYPE employment_type_enum AS ENUM ('Full-time', 'Part-time', 'Contract');
CREATE TYPE department_enum AS ENUM (
    -- Academic Departments
    'Academics',
    'Mathematics',
    'Science',
    'English',
'Telugu',
'Hindi',
    'Social Studies',
    'Languages',
    'Physical Education',
    
    -- Administrative Departments
    'Administration',
    'Admissions',
    'Accounts',
    'Human Resources',
    
    -- Support Departments
    'IT Support',
    'Library',
    'Transport',
    'Hostel',
    'Security',
    'Maintenance'
);

 


CREATE TYPE public.event_type_enum AS ENUM (
  'Class Lecture',
    'Test',
    'Lab Session',
    'Field Trip',
    'Study Hall',
'Holiday',
    'School Event',          
    'Meeting',               
    'Parent-Teacher Meet',
    'Professional Development', 
'Maintenance',          
    'Personal Appointment'  
);
CREATE TYPE public.event_status_enum AS ENUM (
    'Yet to be start',   -- Event is in the future
    'Ongoing',           -- The master recurrence rule is active (for recurring events)
    'Completed',         -- A non-recurring event is over
    'Canceled',          -- Event has been officially canceled
    'Postponed'
);
CREATE TABLE calendar_events (
 event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
    campus_id UUID NOT NULL REFERENCES public.campuses(campus_id),
    academic_year_id INTEGER NOT NULL REFERENCES public.academic_years(academic_year_id), 
event_name VARCHAR(255) NOT NULL,
    event_description TEXT,
    event_type public.event_type_enum NOT NULL,              -- Uses the new ENUM
    scheduled_by BIGINT REFERENCES public.users(user_id), 
start_date DATE NOT NULL,
end_date DATE NOT NULL,
start_time TIME NOT NULL,
end_time TIME NOT null,
recurrence_rule VARCHAR(255), 
 audience_target JSONB NOT NULL DEFAULT '{"target_type": "Tenant", "target_id": null}',
    room_id INTEGER REFERENCES public.campus_rooms(room_id),
event_status public.event_status_enum NOT NULL DEFAULT 'Yet to be start'::public.event_status_enum, -- Uses the new ENUM
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
CONSTRAINT check_date_range CHECK (start_date <= end_date),
constraint check_time_range CHECK (start_time < end_time));


CREATE INDEX idx_calendar_events_date_range ON public.calendar_events (start_date, end_date);

CREATE TABLE calendar_event_instances (
    instance_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_id UUID NOT NULL REFERENCES public.calendar_events(event_id) ON DELETE CASCADE,
    original_start_date DATE NOT NULL,
    actual_start_date DATE,
    actual_end_date DATE,
    actual_start_time TIME,
    actual_end_time TIME,
    is_cancelled BOOLEAN DEFAULT FALSE,
    specific_description TEXT, 
room_id INTEGER REFERENCES public.campus_rooms(room_id),
updated_by BIGINT REFERENCES public.users(user_id), 
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TYPE public.attendance_status_enum AS ENUM (
    'Present',
    'Absent',
    'Late',
    'Excused',
    'Left Early'
);

CREATE TABLE event_attendance (
event_attendance_id SERIAL PRIMARY KEY,
attendance_date DATE NOT null,
academic_year_id INT REFERENCES academic_years(academic_year_id),
event_id UUID NOT NULL REFERENCES calendar_events(event_id) ON DELETE CASCADE,
audience_id BIGINT NOT NULL REFERENCES public.users(user_id) ON DELETE CASCADE,
attendance_status public.attendance_status_enum NOT NULL,
total_scheduled_hours DECIMAL(5, 2) NOT NULL,
actual_present_hours DECIMAL(5, 2) NOT NULL,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
CONSTRAINT check_present_hours_valid CHECK (actual_present_hours >= 0 AND actual_present_hours <= total_scheduled_hours),
CONSTRAINT unique_event_audience_date UNIQUE (event_id, audience_id, attendance_date)
);

CREATE INDEX idx_event_attendance_date ON public.event_attendance (attendance_date);


CREATE TABLE academic_year_names (
    year_name varchar(20) PRIMARY KEY
);

-- Populate it with existing names from your current data
INSERT INTO academic_year_names (year_name)
SELECT DISTINCT year_name FROM academic_years
ON CONFLICT DO NOTHING;


CREATE TABLE user_attendance (
    attendance_id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    campus_id uuid NOT null REFERENCES campuses(campus_id) ON DELETE CASCADE,
    year_name varchar(20) NOT null REFERENCES academic_year_names(year_name),
    username varchar(100) NOT null REFERENCES users(username),
    role user_role NOT NULL,
    attendance_date DATE NOT NULL,
    status public.attendance_status_enum NOT NULL,
    duration interval,
total_duration INTERVAL,
login_time TIME,
logout_time TIME,
    constraint unique_user_attendance UNIQUE (username, attendance_date)
);

CREATE TYPE leave_duration_type AS ENUM ('half_day', 'full_day', 'more than half_day','less than half_day');

CREATE TYPE leave_status AS ENUM ('pending', 'approved', 'rejected', 'cancelled');


CREATE TABLE leave_requests (
    id SERIAL PRIMARY KEY,
    username varchar(100) NOT NULL REFERENCES users(username),
    requester_role user_role NOT NULL,
    campus_id uuid NOT NULL REFERENCES campuses(campus_id) ON DELETE CASCADE,
    request_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    leave_date DATE NOT NULL,
    leave_reason TEXT NOT NULL,
    duration_days DECIMAL(3, 1) NOT NULL,
    duration_category leave_duration_type NOT NULL,
    overall_status leave_status DEFAULT 'pending'
);
CREATE TABLE leave_approval_steps (
    id SERIAL PRIMARY KEY,
    leave_request_id INTEGER REFERENCES leave_requests(id) ON DELETE CASCADE,
    approver_role user_role NOT NULL, -- e.g., 'teacher', 'principal'
    approver_username varchar(100) REFERENCES users(username), -- Assigned person
    status leave_status DEFAULT 'pending',
    step_order INTEGER NOT NULL, -- 1 for Teacher, 2 for Principal, etc.
    comments TEXT,
    action_date TIMESTAMP WITH TIME ZONE,
    
    UNIQUE(leave_request_id, approver_username)
);
Create INDEX idx_leave_applied_to ON leave_requests(applied_to_username);
-- Index for users to see their own history
CREATE INDEX idx_leave_user_id ON leave_requests(username);

CREATE TABLE holiday_events (
    id SERIAL PRIMARY KEY,
    campus_id UUID REFERENCES campuses(campus_id),
    holiday_name VARCHAR(255) NOT NULL,
    duration_category leave_duration_type NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    holiday_type VARCHAR(50), 
    is_paid BOOLEAN DEFAULT TRUE
);

CREATE TABLE holiday_curriculum_map (
    id SERIAL PRIMARY KEY,
    holiday_id INTEGER REFERENCES holiday_events(id) ON DELETE CASCADE,
    campus_id UUID REFERENCES campuses(campus_id),
academic_year_id INTEGER NOT NULL REFERENCES public.academic_years(academic_year_id),
    constraint unique_holiday_campus_academicyear UNIQUE(holiday_id, campus_id,academic_year_id)
);

CREATE TABLE weekend_policies (
    id SERIAL PRIMARY KEY,
    campus_id UUID REFERENCES campuses(campus_id) ON DELETE CASCADE,
    academic_year_id INTEGER NOT NULL REFERENCES public.academic_years(academic_year_id) ON DELETE CASCADE,
	is_sunday_holiday BOOLEAN DEFAULT TRUE,
    is_saturday_holiday BOOLEAN DEFAULT TRUE,
    is_saturday_half_day BOOLEAN DEFAULT FALSE,
    UNIQUE(campus_id, academic_year_id)
);

CREATE TABLE special_working_days (
    id SERIAL PRIMARY KEY,
    campus_id UUID REFERENCES campuses(campus_id) ON DELETE CASCADE,
academic_year_id INTEGER NOT NULL REFERENCES public.academic_years(academic_year_id) ON DELETE CASCADE,
    work_date DATE NOT NULL,
    description VARCHAR(255), -- e.g., 'Annual Function' or 'Exam Day'
    
    UNIQUE(campus_id, work_date,academic_year_id)
);

CREATE TABLE fee_types (
    fee_type_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
     campus_id uuid NOT null REFERENCES campuses(campus_id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL, -- e.g., "Annual Tuition"
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE fee_structures (
    fee_structure_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
    campus_id uuid NOT null REFERENCES campuses(campus_id) ON DELETE CASCADE,
    academic_year_id INTEGER NOT NULL REFERENCES public.academic_years(academic_year_id),
    class_id UUID NOT NULL, -- Reference your classes/grades table
    fee_type_id UUID NOT NULL REFERENCES fee_types(fee_type_id),
    total_amount DECIMAL(12, 2) NOT NULL,
    UNIQUE(class_id, fee_type_id, academic_year_id)
);

CREATE TABLE fee_installments (
    installment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    fee_structure_id UUID NOT NULL REFERENCES fee_structures(fee_structure_id) ON DELETE CASCADE,
    installment_name VARCHAR(50) NOT NULL, 
    due_date DATE NOT NULL,
    amount DECIMAL(12, 2) NOT NULL,
    penalty_amount DECIMAL(12, 2) DEFAULT 0.00
);

--- 4. Student Fee Assignments (Tracking what each student owes)
CREATE TABLE student_fee_dues (
    due_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_id UUID NOT NULL, -- Reference your students table
    installment_id UUID NOT NULL REFERENCES fee_installments(installment_id),
    discount_amount DECIMAL(12, 2) DEFAULT 0.00,
    is_paid BOOLEAN DEFAULT FALSE,
    balance_amount DECIMAL(12, 2) NOT NULL, -- Initially same as installment amount
    UNIQUE(student_id, installment_id)
);

CREATE TYPE payment_method_enum AS ENUM ('Cash', 'Bank Transfer', 'Cheque', 'Online');
CREATE TABLE fee_payments (
    payment_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
    student_id UUID NOT NULL,
    amount_paid DECIMAL(12, 2) NOT NULL,
    payment_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    payment_method payment_method_enum DEFAULT 'Cash',
    transaction_reference VARCHAR(255), -- Cheque no, UTR no, etc.
    collected_by BIGINT REFERENCES public.users(user_id),
    remarks TEXT
);

--- 6. Payment Allocation (Linking 1 payment to multiple installment dues)
CREATE TABLE payment_allocations (
    allocation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    payment_id UUID NOT NULL REFERENCES fee_payments(payment_id),
    due_id UUID NOT NULL REFERENCES student_fee_dues(due_id),
    amount_allocated DECIMAL(12, 2) NOT NULL
);

CREATE TABLE exams (
    exam_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
    campus_id UUID NOT NULL REFERENCES public.campuses(campus_id),
    event_id UUID NOT NULL REFERENCES calendar_events(event_id) ON DELETE CASCADE,
    subject_name VARCHAR(100) NOT NULL,
exam_date DATE NOT NULL, 
    
    total_score DECIMAL(6, 2) NOT NULL DEFAULT 100.00,
    passing_score DECIMAL(6, 2) GENERATED ALWAYS AS (total_score * 0.35) STORED,
  CONSTRAINT unique_exam_per_day_per_event UNIQUE(event_id, exam_date)
);

CREATE OR REPLACE FUNCTION validate_exam_date_range()
RETURNS TRIGGER AS $$
DECLARE
    event_start DATE;
    event_end DATE;
BEGIN
    -- Fetch the range from the parent calendar_event
    SELECT start_date, end_date INTO event_start, event_end
    FROM calendar_events
    WHERE event_id = NEW.event_id;

    -- If no date is provided, default it to the event's start_date
    IF NEW.exam_date IS NULL THEN
        NEW.exam_date := event_start;
    END IF;

    -- Constraint: Date must be within event range
    IF NEW.exam_date < event_start OR NEW.exam_date > event_end THEN
        RAISE EXCEPTION 'Exam date (%) must be between event start (%) and end (%)', 
            NEW.exam_date, event_start, event_end;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 3. Trigger to run the function before INSERT or UPDATE

CREATE TRIGGER trg_validate_exam_date
BEFORE INSERT OR UPDATE ON exams
FOR EACH ROW
EXECUTE FUNCTION validate_exam_date_range();

CREATE TYPE exam_attendance_status_enum AS ENUM ('Present', 'Absent', 'Excused');

CREATE TABLE exam_results (
    result_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(tenant_id),
campus_id UUID NOT NULL REFERENCES public.campuses(campus_id)
    exam_id UUID NOT NULL REFERENCES exams(exam_id) ON DELETE CASCADE,
   student_username  VARCHAR(100)  NOT NULL REFERENCES users(username);

    attendance_status exam_attendance_status_enum DEFAULT 'Present',
    obtained_score DECIMAL(6, 2) DEFAULT 0.00,
    is_passed BOOLEAN default true
Unique(campus_id,exam_id,student_username)

);

Enums:
public	syllabus_status	Pending
public	syllabus_status	In Progress
public	syllabus_status	Completed
public	syllabus_status	Skipped

public	year_type_enum	Current year
public	year_type_enum	Previous year
public	year_type_enum	Next year
